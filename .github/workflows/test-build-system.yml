# This workflow will thoroughly test the build system
name: Complete build system test

on:
  push:
    branches: '**'
  pull_request:
    branches: '**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install --no-install-recommends git make optipng gettext gnome-shell libglib2.0-bin

    - name: Check asset optimisation targets work
      run: |
        # Check all assets are space optimised
        make prune
        make compress

    - name: Check asset generation target(s) work
      run: |
        make translations
        git restore po/messages.pot

    - name: Test extension builds from a clean slate
      run: |
        make build

    - name: Test extension is valid and able to be uploaded
      run: |
        make check

    - name: Check no extra files have been committed
      run: |
        # Clean up files (Shouldn't have to do anything)
        make clean
        # Fail if any files generated by last step that haven't been committed
        if [ ! -z "$(git status --porcelain)" ]; then exit 1; fi

    - name: Check release workflow is functional
      run: |
        make release

    - name: Test extension installs and uninstalls
      run: |
        make install
        make uninstall
